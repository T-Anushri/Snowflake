-- count of branches per state
SELECT ID_COUNTRY,ID_STATE,state_abbreviation, COUNT(*) AS ACTIVE_BRANCH_COUNT, b.geo_name
FROM FINANCIAL_BRANCH_ENTITIES AS a JOIN GEOGRAPHY_INDEX  AS b
ON a.ID_STATE=b.GEO_ID
WHERE IS_ACTIVE = TRUE
AND ID_COUNTRY='country/USA'
GROUP BY 1,2,3,5
ORDER BY ACTIVE_BRANCH_COUNT DESC;

-- count of branches per bank
SELECT NAME_PARENT, COUNT(*) AS ACTIVE_BRANCH_COUNT
FROM FINANCIAL_BRANCH_ENTITIES 
WHERE IS_ACTIVE = TRUE
GROUP BY 1
ORDER BY ACTIVE_BRANCH_COUNT DESC
LIMIT 10;

-- 
SELECT STATE_ABBREVIATION, COUNT(*) AS ACTIVE_BRANCH_COUNT
FROM FINANCIAL_BRANCH_ENTITIES 
WHERE IS_ACTIVE = TRUE
GROUP BY 1,2,3
ORDER BY ACTIVE_BRANCH_COUNT DESC;

SELECT CITY, COUNT(*) AS TOTAL_BRANCHES
FROM FINANCIAL_BRANCH_ENTITIES
WHERE IS_ACTIVE = TRUE
GROUP BY CITY
ORDER BY TOTAL_BRANCHES DESC
LIMIT 10;

SELECT ID_RSSD_PARENT,NAME_PARENT,EXTRACT(YEAR FROM START_DATE) AS YEAR, COUNT(*) AS BRANCHES_OPENED
FROM FINANCIAL_BRANCH_ENTITIES
WHERE START_DATE IS NOT NULL
AND YEAR >= 2000
GROUP BY ID_RSSD_PARENT,NAME_PARENT,YEAR 
ORDER BY YEAR;

SELECT NAME_PARENT, NAME_BRANCH, COUNT(*) AS TOTAL_BRANCHES
FROM FINANCIAL_BRANCH_ENTITIES
WHERE NAME_PARENT IS NOT NULL
GROUP BY NAME_PARENT, NAME_BRANCH
ORDER BY NAME_PARENT, TOTAL_BRANCHES DESC;



SELECT TRANSFORMATION_TYPE, COUNT(*) AS EVENT_COUNT
FROM FINANCIAL_INSTITUTION_EVENTS
GROUP BY TRANSFORMATION_TYPE
ORDER BY EVENT_COUNT DESC;

SELECT ID_RSSD, SUM(VALUE)
FROM FINANCIAL_INSTITUTION_TIMESERIES
WHERE 
        (VARIABLE_NAME LIKE '%Income%' 
        OR VARIABLE_NAME LIKE '%Revenue%'
        OR VARIABLE_NAME LIKE '%Profit%'
        OR VARIABLE_NAME LIKE '%Noninterest Income%'
        OR VARIABLE_NAME LIKE '%Operating Income%')
        AND VALUE>0
        AND UNIT='USD'
        AND ID_RSSD=852320
GROUP BY ID_RSSD
ORDER BY SUM(VALUE) DESC;

SELECT NAME,ID_RSSD FROM FINANCE__ECONOMICS.CYBERSYN.FINANCIAL_INSTITUTION_ENTITIES
WHERE ID_RSSD IN (
852218,
480228,
451965,
476810,
504713,
1394676,
817824,
541101,
35301,
2253891
);

SELECT ID_RSSD, NAME FROM FINANCE__ECONOMICS.CYBERSYN.FINANCIAL_INSTITUTION_ENTITIES
WHERE NAME IN (
'Td Bank, National Association',
'Truist Bank'
);

SELECT TRANSACTION_VALUE, ID_RSSD
FROM (
SELECT ID_RSSD, AVG(VALUE) AS TRANSACTION_VALUE
FROM FINANCIAL_INSTITUTION_TIMESERIES
WHERE UNIT='USD'  
GROUP BY ID_RSSD
)
WHERE ID_RSSD IN (
852218,
480228,
451965,
476810,
504713,
817824,
852320,
541101,
2253891,
1394676
);

SELECT ID_RSSD,VALUE, DATE
FROM FINANCIAL_INSTITUTION_TIMESERIES
WHERE UNIT='USD'  

CREATE OR REPLACE TABLE CRISIS AS 
WITH operating_income_data AS (
WITH operating AS (
    SELECT
        ID_RSSD,
        VARIABLE_NAME,
        DATE,
        VALUE AS operating_income
    FROM
        BANK
    WHERE
        VARIABLE_NAME LIKE '%Income%'  
        OR VARIABLE_NAME LIKE '%Revenue%'
        OR VARIABLE_NAME LIKE '%Profit%'
        OR VARIABLE_NAME LIKE '%Noninterest Income%'
        OR VARIABLE_NAME LIKE '%Operating Income%'
        AND DATE BETWEEN '2007-01-01' AND '2009-12-31'  
)

SELECT
    o.ID_RSSD,
    SUM(CASE WHEN EXTRACT(YEAR FROM o.DATE) = 2007 THEN o.operating_income ELSE 0 END) AS income_2007,
    SUM(CASE WHEN EXTRACT(YEAR FROM o.DATE) = 2008 THEN o.operating_income ELSE 0 END) AS income_2008,
    SUM(CASE WHEN EXTRACT(YEAR FROM o.DATE) = 2009 THEN o.operating_income ELSE 0 END) AS income_2009,
    (SUM(CASE WHEN EXTRACT(YEAR FROM o.DATE) = 2007 THEN o.operating_income ELSE 0 END) -
     SUM(CASE WHEN EXTRACT(YEAR FROM o.DATE) = 2008 THEN o.operating_income ELSE 0 END)) AS loss_in_2008,
    (SUM(CASE WHEN EXTRACT(YEAR FROM o.DATE) = 2008 THEN o.operating_income ELSE 0 END) -
     SUM(CASE WHEN EXTRACT(YEAR FROM o.DATE) = 2009 THEN o.operating_income ELSE 0 END)) AS loss_in_2009
FROM
    operating o
GROUP BY
    o.ID_RSSD
ORDER BY
    loss_in_2008 DESC, loss_in_2009 DESC
)

SELECT ID_RSSD, 2008 AS Year, 'Income' AS Metric, income_2008 AS Value
FROM operating_income_data o WHERE ID_RSSD IN (
852218,
480228,
451965,
476810,
504713,
817824,
852320,
541101,
2253891,
1394676
)

UNION ALL

SELECT ID_RSSD, 2009 AS Year, 'Income' AS Metric, income_2009 AS Value
FROM operating_income_data o WHERE ID_RSSD IN (
852218,
480228,
451965,
476810,
504713,
817824,
852320,
541101,
2253891,
1394676
)

UNION ALL

SELECT ID_RSSD, 2008 AS Year, 'Loss' AS Metric, loss_in_2008 AS Value
FROM operating_income_data o WHERE ID_RSSD IN (
852218,
480228,
451965,
476810,
504713,
817824,
852320,
541101,
2253891,
1394676
)

UNION ALL

SELECT ID_RSSD, 2009 AS Year, 'Loss' AS Metric, loss_in_2009 AS Value
FROM operating_income_data o WHERE ID_RSSD IN (
852218,
480228,
451965,
476810,
504713,
817824,
852320,
541101,
2253891,
1394676
);



SELECT 
    ID_RSSD, 
    YEAR,
    SUM(CASE WHEN METRIC = 'Income' THEN VALUE ELSE 0 END) AS TOTAL_INCOME,
    SUM(CASE WHEN METRIC = 'Loss' THEN VALUE ELSE 0 END) AS TOTAL_LOSS,
    CASE 
        WHEN SUM(CASE WHEN METRIC = 'Income' THEN VALUE ELSE 0 END) = 0 THEN 0
        ELSE 
            (SUM(CASE WHEN METRIC = 'Loss' THEN VALUE ELSE 0 END) * 100.0) 
            / SUM(CASE WHEN METRIC = 'Income' THEN VALUE ELSE 0 END)
    END AS PERCENTAGE_INCOME_LOST
FROM crisis
WHERE YEAR BETWEEN 2008 AND 2009
GROUP BY ID_RSSD, YEAR
ORDER BY YEAR, PERCENTAGE_INCOME_LOST DESC;
